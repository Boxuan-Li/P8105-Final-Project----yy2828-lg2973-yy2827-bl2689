---
title: "Final Project"
author: "Boxuan Li, Yangwei Yan, Yunqiu Yao, Lu Gan"
date: "12/5/2017"
output: 
  html_document:
    code_folding: hide
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = F,
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)
library(janitor)
library(ggthemes)
library(stringr)
library(tidytext)
library(viridis)

theme_set(theme_bw())
theme_update(legend.position = "bottom")
```

## Read and Clean the Dataset
```{r Read and clean}
ted <- read_csv("./data/TED.csv") %>%
  clean_names() %>%
  mutate(no = row_number()) %>% 
  select(no, everything(),-event, -film_date, -num_speaker, -related_talks, -name)
```


### 3.3 Sentiment Analysis
(1) Tidy the *ratings* variable
```{r}
ratings = ted %>%
  select(no, ratings) %>% 
  mutate(ratings = substring(ratings,3, nchar(ratings)-2)) %>% 
  mutate(ratings = str_split(ratings,"\\}, \\{")) %>% 
  unnest(ratings) %>% 
  mutate(rat.words = sub(".*name': '(.*?)',.*", "\\1", ratings),
         rat.words = tolower(rat.words),
         rat.cnt = as.numeric(sub(".*'count': ", "", ratings))) %>%
  select(-ratings) %>% print()
```

(2) Perform sentiment analysis
```{r}
### read the sentiment dataset from 'bing'
bing_sent = get_sentiments("bing")

#### calculate sentiment value for each observation
rat_sent = ratings %>% 
  rename(word = rat.words) %>% 
  inner_join(bing_sent, by="word") %>% 
  group_by(no,sentiment) %>% 
  summarize(sum_cnt = sum(rat.cnt)) %>% 
  ungroup() %>% 
  spread(sentiment, sum_cnt) %>% 
  mutate(sentiment = (-1) * negative + positive) %>% 
  select(-negative, -positive) %>% 
  left_join(ted) 

### perfrom sentiment analysis
rat_sent %>% 
  mutate(no = factor(no),
         no = fct_reorder(no, sentiment)) %>% 
  ggplot(aes(no, sentiment, fill=views, color=views)) +
    geom_bar(stat = "identity") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) + 
    scale_fill_viridis() +
    scale_color_viridis()

### try the cube root to reduce skewness
rat_sent %>% 
  mutate(no = factor(no),
         no = fct_reorder(no, sentiment),
         cubert = ifelse(sentiment > 0, sentiment^(1/3), -(-sentiment)^(1/3))) %>% 
  ggplot(aes(no, cubert, fill=views, color=views)) +
    geom_bar(stat = "identity") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) + 
    ylab("cube root of sentiment") +
    scale_fill_viridis() +
    scale_color_viridis()
```

Here in the sentiment analysis, first we extract the sentiment words and the corresponding counts that are nested in the variable *ratings* for each observation, and assign them to two new variables *rat.words* and *rat.cnt*. Then we match the rating words (*rat.words*) with the sentiments dataset from 'bing', defining the rat.words as 'positive' or 'negative'. For each inspection number(*no*), we calculate the difference of sum of positive count and sum of negative count and use it as the sentiment score for this observation. 

After obtaining the sentiment score, we start to make a plot showing the inspection sentiments and the number of viewers. We first coerce the *no* variable to factor and reorder it accorrding to the sentiment score and plot the realtionship between inspection number and sentiment score. However, since there are some observations with extremely large score, making the graph rather skewed, we try the cube root of the outcome (*sentiment*) and plot again to obtain the second graph. It can be seen that most of the ted talks have positive sentiment ratings, since only a small portion on the plot is in the negative side of y axis. Further, we find out that those ted talks with large number of viewers also receive high ratings, since the color yellow and green, which indicate a higher viewers, mostly appear at the right side of the plot, where the sentiment scores are high.

(3) Compare top 10 talks picked by viewers and ratings respectively
```{r}
top10_sent = rat_sent %>% 
  arrange(desc(sentiment)) %>% 
  head(10) %>% print()

top10_view = ted %>%
  arrange(desc(views)) %>% 
  head(10) %>% print()

```



